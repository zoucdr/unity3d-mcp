#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Unity MCP ç¬”è®°æœ¬ç”µè„‘ç½‘æ ¼ç”Ÿæˆå™¨
ä½¿ç”¨Pythonç”Ÿæˆç¬”è®°æœ¬ç”µè„‘çš„å‡ ä½•ä½“æ•°æ®ï¼Œè¾“å‡ºä¸ºUnityå…¼å®¹çš„OBJæ ¼å¼
"""

import math
import os

def create_box_vertices(width, height, depth, center=(0, 0, 0)):
    """åˆ›å»ºç«‹æ–¹ä½“é¡¶ç‚¹"""
    cx, cy, cz = center
    w, h, d = width/2, height/2, depth/2
    
    vertices = [
        # åº•é¢ (y = cy - h)
        (cx - w, cy - h, cz - d),  # 0
        (cx + w, cy - h, cz - d),  # 1
        (cx + w, cy - h, cz + d),  # 2
        (cx - w, cy - h, cz + d),  # 3
        # é¡¶é¢ (y = cy + h)
        (cx - w, cy + h, cz - d),  # 4
        (cx + w, cy + h, cz - d),  # 5
        (cx + w, cy + h, cz + d),  # 6
        (cx - w, cy + h, cz + d),  # 7
    ]
    return vertices

def create_box_faces():
    """åˆ›å»ºç«‹æ–¹ä½“é¢ï¼ˆOBJæ ¼å¼ä½¿ç”¨1å¼€å§‹çš„ç´¢å¼•ï¼‰"""
    faces = [
        # åº•é¢ (y-)
        (1, 2, 3), (1, 3, 4),
        # é¡¶é¢ (y+)
        (5, 7, 6), (5, 8, 7),
        # å‰é¢ (z-)
        (1, 5, 6), (1, 6, 2),
        # åé¢ (z+)
        (4, 3, 7), (4, 7, 8),
        # å·¦é¢ (x-)
        (1, 4, 8), (1, 8, 5),
        # å³é¢ (x+)
        (2, 6, 7), (2, 7, 3),
    ]
    return faces

def create_plane_vertices(width, height, center=(0, 0, 0), normal=(0, 1, 0)):
    """åˆ›å»ºå¹³é¢é¡¶ç‚¹"""
    cx, cy, cz = center
    w, h = width/2, height/2
    
    if normal == (0, 1, 0):  # XZ å¹³é¢ (Y up)
        vertices = [
            (cx - w, cy, cz - h),
            (cx + w, cy, cz - h),
            (cx + w, cy, cz + h),
            (cx - w, cy, cz + h),
        ]
    elif normal == (0, 0, 1):  # XY å¹³é¢ (Z forward)
        vertices = [
            (cx - w, cy - h, cz),
            (cx + w, cy - h, cz),
            (cx + w, cy + h, cz),
            (cx - w, cy + h, cz),
        ]
    else:
        vertices = [
            (cx - w, cy - h, cz),
            (cx + w, cy - h, cz),
            (cx + w, cy + h, cz),
            (cx - w, cy + h, cz),
        ]
    
    return vertices

def create_plane_faces():
    """åˆ›å»ºå¹³é¢é¢"""
    return [(1, 2, 3), (1, 3, 4)]

def generate_keyboard_keys(keyboard_center, keyboard_width, keyboard_depth, key_size=0.02):
    """ç”Ÿæˆé”®ç›˜æŒ‰é”®"""
    vertices = []
    faces = []
    current_vertex_index = 1
    
    cx, cy, cz = keyboard_center
    
    # é”®ç›˜å¸ƒå±€å‚æ•°
    rows = 5
    cols = 14
    key_spacing = 0.025
    row_spacing = 0.025
    
    start_x = cx - (cols - 1) * key_spacing / 2
    start_z = cz - (rows - 1) * row_spacing / 2
    
    for row in range(rows):
        for col in range(cols):
            # è·³è¿‡ä¸€äº›ä½ç½®æ¥æ¨¡æ‹ŸçœŸå®é”®ç›˜å¸ƒå±€
            if row == 0 and col > 11:  # åŠŸèƒ½é”®è¡Œè¾ƒçŸ­
                continue
            if row == 4 and (col < 2 or col > 11):  # ç©ºæ ¼é”®è¡Œ
                continue
                
            key_x = start_x + col * key_spacing
            key_z = start_z + row * row_spacing
            key_y = cy + 0.001  # ç¨å¾®é«˜äºé”®ç›˜è¡¨é¢
            
            # ä¸ºç©ºæ ¼é”®åˆ›å»ºæ›´å®½çš„æŒ‰é”®
            if row == 4 and 4 <= col <= 9:  # ç©ºæ ¼é”®ä½ç½®
                if col == 4:  # åªåœ¨ç©ºæ ¼é”®å¼€å§‹ä½ç½®åˆ›å»ºä¸€ä¸ªå¤§æŒ‰é”®
                    key_width = key_spacing * 6
                    key_vertices = create_box_vertices(key_width, key_size/2, key_size, (key_x + key_spacing*2.5, key_y, key_z))
                else:
                    continue
            else:
                key_vertices = create_box_vertices(key_size, key_size/2, key_size, (key_x, key_y, key_z))
            
            # æ·»åŠ é¡¶ç‚¹
            for vertex in key_vertices:
                vertices.append(vertex)
            
            # æ·»åŠ é¢ï¼ˆè°ƒæ•´ç´¢å¼•ï¼‰
            key_faces = create_box_faces()
            for face in key_faces:
                adjusted_face = tuple(current_vertex_index + i - 1 for i in face)
                faces.append(adjusted_face)
            
            current_vertex_index += len(key_vertices)
    
    return vertices, faces

def write_obj_file(filename, vertices, faces, normals=None, uvs=None):
    """å°†å‡ ä½•ä½“æ•°æ®å†™å…¥OBJæ–‡ä»¶"""
    print(f"æ­£åœ¨ç”Ÿæˆ OBJ æ–‡ä»¶: {filename}")
    
    with open(filename, 'w', encoding='utf-8') as f:
        f.write(f"# ç¬”è®°æœ¬ç”µè„‘ç½‘æ ¼ - {os.path.basename(filename)}\n")
        f.write("# Generated by Unity MCP Python Runner\n\n")
        
        # å†™å…¥é¡¶ç‚¹
        for vertex in vertices:
            f.write(f"v {vertex[0]:.6f} {vertex[1]:.6f} {vertex[2]:.6f}\n")
        f.write("\n")
        
        # å†™å…¥æ³•çº¿ï¼ˆå¦‚æœæä¾›ï¼‰
        if normals:
            for normal in normals:
                f.write(f"vn {normal[0]:.6f} {normal[1]:.6f} {normal[2]:.6f}\n")
            f.write("\n")
        
        # å†™å…¥UVåæ ‡ï¼ˆå¦‚æœæä¾›ï¼‰
        if uvs:
            for uv in uvs:
                f.write(f"vt {uv[0]:.6f} {uv[1]:.6f}\n")
            f.write("\n")
        
        # å†™å…¥é¢
        for face in faces:
            if len(face) == 3:
                f.write(f"f {face[0]} {face[1]} {face[2]}\n")
            elif len(face) == 4:
                f.write(f"f {face[0]} {face[1]} {face[2]} {face[3]}\n")
    
    print(f"OBJ æ–‡ä»¶ç”Ÿæˆå®Œæˆ: {filename}")

def create_laptop_mesh():
    """åˆ›å»ºç¬”è®°æœ¬ç”µè„‘ç½‘æ ¼"""
    print("å¼€å§‹ç”Ÿæˆç¬”è®°æœ¬ç”µè„‘ç½‘æ ¼...")
    
    # ç¡®ä¿è¾“å‡ºç›®å½•å­˜åœ¨
    assets_dir = "Assets/Meshes"
    if not os.path.exists(assets_dir):
        os.makedirs(assets_dir)
        print(f"åˆ›å»ºç›®å½•: {assets_dir}")
    
    # ç¬”è®°æœ¬ç”µè„‘ç»„ä»¶å°ºå¯¸å‚æ•°
    laptop_width = 0.35
    laptop_depth = 0.25
    base_height = 0.02
    screen_height = 0.02
    screen_lift = 0.15  # å±å¹•æŠ¬èµ·é«˜åº¦
    
    # ======== 1. åˆ›å»ºç¬”è®°æœ¬åº•åº§ ========
    print("ç”Ÿæˆç¬”è®°æœ¬åº•åº§...")
    base_vertices = create_box_vertices(laptop_width, base_height, laptop_depth, (0, 0, 0))
    base_faces = create_box_faces()
    
    write_obj_file(f"{assets_dir}/LaptopBase.obj", base_vertices, base_faces)
    
    # ======== 2. åˆ›å»ºå±å¹•å¤–å£³ ========
    print("ç”Ÿæˆå±å¹•å¤–å£³...")
    screen_center = (0, screen_lift, laptop_depth/2 + 0.01)
    screen_vertices = create_box_vertices(laptop_width, screen_height, laptop_depth, screen_center)
    screen_faces = create_box_faces()
    
    write_obj_file(f"{assets_dir}/LaptopScreen.obj", screen_vertices, screen_faces)
    
    # ======== 3. åˆ›å»ºé”®ç›˜åŒºåŸŸ ========
    print("ç”Ÿæˆé”®ç›˜...")
    keyboard_center = (0, base_height/2 + 0.001, -0.05)
    keyboard_vertices = create_box_vertices(laptop_width * 0.9, 0.005, laptop_depth * 0.7, keyboard_center)
    keyboard_faces = create_box_faces()
    
    # ç”ŸæˆæŒ‰é”®
    key_vertices, key_faces = generate_keyboard_keys(keyboard_center, laptop_width * 0.9, laptop_depth * 0.7)
    
    # åˆå¹¶é”®ç›˜åº•æ¿å’ŒæŒ‰é”®
    all_keyboard_vertices = keyboard_vertices + key_vertices
    all_keyboard_faces = keyboard_faces.copy()
    
    # è°ƒæ•´æŒ‰é”®é¢çš„ç´¢å¼•
    vertex_offset = len(keyboard_vertices)
    for face in key_faces:
        adjusted_face = tuple(i + vertex_offset for i in face)
        all_keyboard_faces.append(adjusted_face)
    
    write_obj_file(f"{assets_dir}/LaptopKeyboard.obj", all_keyboard_vertices, all_keyboard_faces)
    
    # ======== 4. åˆ›å»ºå±å¹•æ˜¾ç¤ºé¢æ¿ ========
    print("ç”Ÿæˆå±å¹•æ˜¾ç¤ºé¢æ¿...")
    panel_center = (0, screen_lift, laptop_depth/2 + screen_height/2 + 0.001)
    panel_vertices = create_plane_vertices(laptop_width * 0.85, laptop_depth * 0.85, panel_center, (0, 0, 1))
    panel_faces = create_plane_faces()
    
    write_obj_file(f"{assets_dir}/LaptopScreenPanel.obj", panel_vertices, panel_faces)
    
    # ======== 5. åˆ›å»ºè§¦æ‘¸æ¿ ========
    print("ç”Ÿæˆè§¦æ‘¸æ¿...")
    touchpad_center = (0, base_height/2 + 0.001, laptop_depth/4)
    touchpad_vertices = create_plane_vertices(0.15, 0.1, touchpad_center, (0, 1, 0))
    touchpad_faces = create_plane_faces()
    
    write_obj_file(f"{assets_dir}/LaptopTouchpad.obj", touchpad_vertices, touchpad_faces)
    
    # ======== 6. åˆ›å»ºå®Œæ•´ç¬”è®°æœ¬ç½‘æ ¼ ========
    print("ç”Ÿæˆå®Œæ•´ç¬”è®°æœ¬ç½‘æ ¼...")
    
    # åˆå¹¶æ‰€æœ‰ç»„ä»¶
    all_vertices = []
    all_faces = []
    current_index = 1
    
    # æ·»åŠ åº•åº§
    all_vertices.extend(base_vertices)
    all_faces.extend(base_faces)
    current_index += len(base_vertices)
    
    # æ·»åŠ å±å¹•
    all_vertices.extend(screen_vertices)
    for face in screen_faces:
        adjusted_face = tuple(i + current_index - 1 for i in face)
        all_faces.append(adjusted_face)
    current_index += len(screen_vertices)
    
    # æ·»åŠ é”®ç›˜ï¼ˆåŒ…æ‹¬æŒ‰é”®ï¼‰
    all_vertices.extend(all_keyboard_vertices)
    for face in all_keyboard_faces:
        adjusted_face = tuple(i + current_index - 1 for i in face)
        all_faces.append(adjusted_face)
    current_index += len(all_keyboard_vertices)
    
    # æ·»åŠ å±å¹•é¢æ¿
    all_vertices.extend(panel_vertices)
    for face in panel_faces:
        adjusted_face = tuple(i + current_index - 1 for i in face)
        all_faces.append(adjusted_face)
    current_index += len(panel_vertices)
    
    # æ·»åŠ è§¦æ‘¸æ¿
    all_vertices.extend(touchpad_vertices)
    for face in touchpad_faces:
        adjusted_face = tuple(i + current_index - 1 for i in face)
        all_faces.append(adjusted_face)
    
    # å†™å…¥å®Œæ•´ç½‘æ ¼
    write_obj_file(f"{assets_dir}/LaptopMesh.obj", all_vertices, all_faces)
    
    print(f"\nâœ… ç¬”è®°æœ¬ç”µè„‘ç½‘æ ¼ç”Ÿæˆå®Œæˆï¼")
    print(f"ğŸ“ è¾“å‡ºç›®å½•: {assets_dir}")
    print("ğŸ® ç°åœ¨å¯ä»¥å°†è¿™äº›OBJæ–‡ä»¶å¯¼å…¥åˆ°Unityä¸­ä½¿ç”¨")
    
    # è¾“å‡ºç”Ÿæˆçš„æ–‡ä»¶åˆ—è¡¨
    generated_files = [
        "LaptopBase.obj",
        "LaptopScreen.obj", 
        "LaptopKeyboard.obj",
        "LaptopScreenPanel.obj",
        "LaptopTouchpad.obj",
        "LaptopMesh.obj"
    ]
    
    print("\nğŸ“‹ ç”Ÿæˆçš„æ–‡ä»¶:")
    for file in generated_files:
        print(f"   â€¢ {file}")
    
    return generated_files

def generate_basic_texture_data():
    """ç”ŸæˆåŸºæœ¬çº¹ç†æ•°æ®ä¿¡æ¯"""
    print("\nğŸ¨ çº¹ç†å»ºè®®:")
    print("   â€¢ é”®ç›˜çº¹ç†: æ·±ç°è‰²ï¼Œå¸¦æœ‰æŒ‰é”®æ ‡è®°")
    print("   â€¢ å±å¹•çº¹ç†: é»‘è‰²æˆ–æ·±è“è‰²èƒŒæ™¯")
    print("   â€¢ æœºèº«çº¹ç†: é“¶ç°è‰²é‡‘å±è´¨æ„Ÿ")
    print("   â€¢ è§¦æ‘¸æ¿çº¹ç†: å…‰æ»‘çš„æ·±ç°è‰²è¡¨é¢")

if __name__ == "__main__":
    # ç”Ÿæˆç¬”è®°æœ¬ç”µè„‘ç½‘æ ¼
    generated_files = create_laptop_mesh()
    generate_basic_texture_data()
    
    print(f"\nğŸ¯ ä¸‹ä¸€æ­¥:")
    print("1. ä½¿ç”¨Unity MCPå°†OBJæ–‡ä»¶å¯¼å…¥Unity")
    print("2. ä¸ºä¸åŒéƒ¨ä»¶åˆ›å»ºæè´¨")
    print("3. ç»„è£…æˆå®Œæ•´çš„ç¬”è®°æœ¬ç”µè„‘é¢„åˆ¶ä½“")

